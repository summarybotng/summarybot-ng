# ADR-008: Unified Summary Experience â€” Archive and Real-time Parity

**Status:** Proposed
**Date:** 2026-02-20
**Depends on:** ADR-006 (Retrospective Summary Archive), ADR-005 (Summary Delivery Destinations), ADR-004 (Grounded Summary References)
**Repository:** [summarybotng/summarybot-ng](https://github.com/summarybotng/summarybot-ng)

---

## 1. Problem Statement

Currently, archive (retrospective) summaries and real-time summaries have divergent storage, metadata, and UI experiences:

1. **Different Storage** â€” Real-time summaries are stored in the database with full metadata. Archive summaries are stored as Markdown files with companion `.meta.json` files.

2. **Missing Generation Details** â€” Archive summaries don't expose generation details (prompt, source messages, tokens, model) in the UI, while real-time summaries do via the "View Generation Details" button.

3. **No Share to Channel** â€” Archive summaries cannot be pushed to Discord channels like real-time summaries can.

4. **Inconsistent UI** â€” Archive summaries appear in a separate tab with different card styling and fewer features.

5. **Model Selection** â€” Archive generation uses a fixed model regardless of summary type (brief/detailed/comprehensive), while ideal behavior would match model capability to summary complexity.

---

## 2. Decision

Implement **unified summary experience** that:

1. **Stores archive summaries in the database** alongside real-time summaries with a flag indicating source
2. **Preserves generation metadata** (prompt version, model, tokens, cost) for all summaries
3. **Enables "Push to Channel"** for archive summaries
4. **Provides "View Generation Details"** for archive summaries
5. **Auto-selects model by summary type**:
   - `brief` â†’ Fast/cheap model (Claude Haiku)
   - `detailed` â†’ Balanced model (Claude Sonnet)
   - `comprehensive` â†’ Best model (Claude Sonnet)

### 2.1 Summary Source Types

```python
class SummarySource(Enum):
    """Origin of a summary."""
    REALTIME = "realtime"      # Generated from live Discord activity
    SCHEDULED = "scheduled"     # Generated by a schedule
    MANUAL = "manual"           # Generated on-demand via dashboard
    ARCHIVE = "archive"         # Retrospective generation from historical data
    IMPORTED = "imported"       # Imported from external source (WhatsApp export, etc.)
```

### 2.2 Unified Summary Schema

All summaries (regardless of source) share the same database schema:

```python
class Summary(BaseModel):
    id: str                          # Unique identifier
    guild_id: str                    # Discord server ID
    channel_id: Optional[str]        # Channel ID (null for server-wide)
    channel_name: str                # Display name

    # Time range
    start_time: datetime
    end_time: datetime
    timezone: str

    # Content
    summary_text: str
    key_points: List[str]
    action_items: List[ActionItem]
    references: List[Reference]       # ADR-004 grounded references

    # Statistics
    message_count: int
    participant_count: int
    word_count: int

    # Generation metadata
    source: SummarySource             # NEW: Where this summary came from
    summary_length: str               # brief, detailed, comprehensive
    perspective: str                  # general, developer, executive, etc.

    # Generation details (for "View Generation Details")
    generation: GenerationMetadata

    # Timestamps
    created_at: datetime
    updated_at: Optional[datetime]

    # Archive-specific (null for realtime)
    archive_period: Optional[str]     # e.g., "2026-01-15" for daily
    archive_granularity: Optional[str] # daily, weekly, monthly


class GenerationMetadata(BaseModel):
    """Detailed generation information for transparency."""
    model: str                        # e.g., "anthropic/claude-3.5-sonnet"
    model_requested: Optional[str]    # What was requested (may differ from actual)

    prompt_version: str               # e.g., "2.1.0"
    prompt_checksum: str              # e.g., "sha256:a1b2c3d4"
    prompt_file: Optional[str]        # Path to prompt template

    tokens_input: int
    tokens_output: int
    tokens_total: int

    cost_usd: float
    pricing_version: str

    duration_ms: int                  # Generation time

    # For debugging/transparency
    has_prompt_data: bool             # Whether full prompt is available
    source_message_count: int         # Messages fed to the model
```

### 2.3 Model Selection by Summary Type

```python
def get_model_for_summary_type(
    summary_type: str,
    explicit_model: Optional[str] = None
) -> str:
    """
    Select appropriate model based on summary complexity.

    Args:
        summary_type: brief, detailed, or comprehensive
        explicit_model: Override model (if user explicitly specifies)

    Returns:
        Model identifier for OpenRouter
    """
    if explicit_model:
        return explicit_model

    MODEL_MAP = {
        "brief": "anthropic/claude-3-haiku",           # Fast, cheap
        "detailed": "anthropic/claude-3.5-sonnet",     # Balanced
        "comprehensive": "anthropic/claude-3.5-sonnet", # Best quality
    }

    return MODEL_MAP.get(summary_type, "anthropic/claude-3-haiku")
```

**Rationale:**
- **Brief summaries** are short extractions that don't need advanced reasoning â†’ Haiku is sufficient and 10x cheaper
- **Detailed summaries** need good extraction and synthesis â†’ Sonnet provides the quality
- **Comprehensive summaries** need the same quality as detailed, output length is the difference

### 2.4 Archive Summary Storage Flow

When archive summaries are generated:

```
1. Generator creates summary content
2. Summary saved to database (unified schema)
3. Summary also written to Markdown file (for portability/sync)
4. Metadata includes source=ARCHIVE, archive_period, etc.
5. Summary appears in both:
   - Summaries page (History tab, with Archive badge)
   - Archive page (for gap analysis, sync status)
```

### 2.5 Push to Channel for Archive Summaries

Archive summaries can be pushed to Discord channels using the same mechanism as real-time summaries:

```python
@router.post("/guilds/{guild_id}/summaries/{summary_id}/push")
async def push_summary_to_channel(
    guild_id: str,
    summary_id: str,
    body: PushToChannelRequest,
):
    """
    Push any summary (realtime or archive) to Discord channel(s).

    Works identically for both summary types.
    """
    # Fetch summary from database (works for both types)
    summary = await summary_repo.get(summary_id)

    # Format and send to Discord
    # ... existing push logic ...
```

### 2.6 View Generation Details for Archive Summaries

Archive summaries store the same generation metadata as real-time summaries:

```json
{
  "generation": {
    "model": "anthropic/claude-3.5-sonnet",
    "prompt_version": "2.1.0",
    "prompt_checksum": "sha256:a1b2c3d4e5f6",
    "tokens_input": 4521,
    "tokens_output": 892,
    "cost_usd": 0.0234,
    "duration_ms": 2341,
    "has_prompt_data": true
  }
}
```

The "View Generation Details" button works identically for archive summaries.

### 2.7 ADR-004 Grounded References for Archive Summaries

Archive summaries support the same **message-level citations** as real-time summaries (per ADR-004). Each key point, action item, decision, and participant contribution traces back to specific source messages.

#### How It Works

1. **Message Numbering** â€” When the archive generator fetches historical messages, it assigns position numbers `[1]`, `[2]`, `[N]` to each message before passing to the summarization engine.

2. **Citation Instructions** â€” The same prompt builder adds citation instructions telling Claude to include `"references": [N, M]` arrays in its structured output.

3. **Reference Resolution** â€” The response parser uses the `PositionIndex` to resolve position numbers to full `MessageReference` objects:

```python
class MessageReference(BaseModel):
    """A citation pointing to a specific source message."""
    message_id: str          # Discord snowflake or source-native ID
    sender: str              # Display name of author
    timestamp: datetime      # When the message was sent
    snippet: str             # Relevant excerpt (max 200 chars)
    position: int            # 1-based position in conversation window
```

4. **Storage** â€” The `reference_index` is stored alongside the summary in both:
   - **Database**: `reference_index` JSON column for API access
   - **Markdown file**: "Sources" table at the bottom for human readability

#### Archive Markdown with Citations

Archive summaries written to Markdown include inline citations and a sources table:

```markdown
## Key Points

- Bob proposed increasing marketing allocation by 15% to recover Q4 shortfall [2][4]
- The team reached consensus to proceed with the increase [5][6]

## Action Items

- [ ] **Bob** to update the Q1 budget spreadsheet [6]

---

### Sources

| # | Who | When | Said |
|---|-----|------|------|
| [2] | Bob | 14:32 | "I think we need to increase the marketing allocation by 15%" |
| [4] | Bob | 14:35 | "Last quarter we underspent on marketing..." |
| [5] | Carol | 14:40 | "I agree with Bob. We lost momentum in Q4." |
| [6] | Alice | 14:42 | "OK, let's go with it. Bob, can you update the spreadsheet?" |
```

#### API Response

Archive summary API responses include the same `references` array as real-time summaries:

```json
{
  "key_points": [
    {
      "text": "Bob proposed increasing marketing allocation by 15%",
      "references": [
        {
          "message_id": "1234567890123456789",
          "sender": "Bob",
          "timestamp": "2026-02-10T14:32:00Z",
          "snippet": "I think we need to increase the marketing allocation by 15%",
          "position": 2
        }
      ],
      "confidence": 0.95
    }
  ],
  "has_references": true,
  "reference_index": [...]
}
```

#### Benefits for Archive Summaries

- **Verifiability** â€” Users can trace any claim back to the original message
- **Trust** â€” Reduces hallucination risk by requiring citations
- **Context** â€” Click a reference to see exactly what was said
- **Consistency** â€” Same reference experience whether real-time or archive

---

## 3. UI Changes

### 3.1 Summaries Page

The History tab shows ALL summaries (realtime + archive) with visual distinction:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Summaries                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                  â”‚
â”‚  [History] [Stored & Share]                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  [Archive] #general  [detailed]  [Details]     Feb 15     â”‚  â”‚
â”‚  â”‚  Today's discussion focused on the Q1 roadmap and...      â”‚  â”‚
â”‚  â”‚  ğŸ“… Feb 15  ğŸ’¬ 47 messages  ğŸ‘¥ 12 participants            â”‚  â”‚
â”‚  â”‚                         [Push to Channel] [View Details]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  #general  [detailed]  [Details]               Feb 14     â”‚  â”‚
â”‚  â”‚  The team discussed deployment strategies and...          â”‚  â”‚
â”‚  â”‚  ğŸ“… Feb 14  ğŸ’¬ 89 messages  ğŸ‘¥ 8 participants             â”‚  â”‚
â”‚  â”‚                         [Push to Channel] [View Details]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Visual Distinction:**
- Archive summaries have an orange `[Archive]` badge
- Real-time summaries have no badge (default)
- Both have identical action buttons

### 3.2 Archive Page Changes

The Archive page focuses on:
- Gap analysis and backfill
- Sync status with Google Drive
- Generation jobs management
- Cost tracking

Summaries themselves are viewed in the Summaries page.

---

## 4. Database Migration

### 4.1 New Columns

```sql
ALTER TABLE summaries ADD COLUMN source VARCHAR(20) DEFAULT 'realtime';
ALTER TABLE summaries ADD COLUMN archive_period VARCHAR(20);
ALTER TABLE summaries ADD COLUMN archive_granularity VARCHAR(20);
ALTER TABLE summaries ADD COLUMN prompt_version VARCHAR(20);
ALTER TABLE summaries ADD COLUMN prompt_checksum VARCHAR(64);
ALTER TABLE summaries ADD COLUMN cost_usd DECIMAL(10, 6);
ALTER TABLE summaries ADD COLUMN pricing_version VARCHAR(20);

-- Index for efficient archive queries
CREATE INDEX idx_summaries_source ON summaries(source);
CREATE INDEX idx_summaries_archive_period ON summaries(archive_period);
```

### 4.2 Migration of Existing Archive Files

Existing archive summaries (Markdown files) are migrated to the database:

```python
async def migrate_archive_to_database():
    """One-time migration of existing archive files to database."""
    archive_root = get_archive_root()

    for meta_file in archive_root.glob("**/sources/**/*.meta.json"):
        metadata = json.loads(meta_file.read_text())
        md_file = meta_file.with_suffix(".md")

        if not md_file.exists():
            continue

        # Create database record
        summary = Summary(
            id=metadata.get("summary_id") or generate_id(),
            guild_id=extract_guild_id(meta_file),
            source=SummarySource.ARCHIVE,
            archive_period=metadata["period"]["start"][:10],
            # ... map other fields ...
        )

        await summary_repo.create(summary)
```

---

## 5. API Changes

### 5.1 List Summaries (Updated)

```
GET /guilds/{guild_id}/summaries?source=all|realtime|archive
```

- `source=all` (default): Returns all summaries
- `source=realtime`: Only realtime/scheduled/manual summaries
- `source=archive`: Only archive summaries

### 5.2 Get Summary (No Change)

```
GET /guilds/{guild_id}/summaries/{summary_id}
```

Works identically for both types.

### 5.3 Push Summary (No Change)

```
POST /guilds/{guild_id}/summaries/{summary_id}/push
```

Works identically for both types.

### 5.4 Get Generation Details (No Change)

```
GET /guilds/{guild_id}/summaries/{summary_id}/prompt
```

Works identically for both types (if `has_prompt_data=true`).

---

## 6. Implementation Phases

### Phase 1: Model Selection (Immediate) âœ…
- [x] Add `get_model_for_summary_type()` function
- [x] Update archive generation to use auto-selected model
- [x] Add job criteria (date range, type, perspective) to job display

### Phase 2: Database Schema âœ…
- [x] Add new columns to stored_summaries table (source, archive_period, archive_granularity, archive_source_key)
- [x] Update StoredSummary model with new fields and SummarySource enum
- [x] Update summary repository with source filtering

### Phase 3: Archive Storage Integration âœ…
- [x] Modify archive generator to save to database via StoredSummaryRepository
- [x] Keep Markdown file generation for portability
- [x] Ensure generation metadata is captured in database
- [ ] Thread `PositionIndex` through archive generator to summarization engine (future)
- [ ] Store `reference_index` in database alongside summary (future - depends on summarization engine integration)
- [ ] Update archive Markdown writer to include citations and Sources table (future)

### Phase 4: UI Unification âœ…
- [x] Add source filter dropdown to Stored & Share tab
- [x] Add source badges to summary cards (Archive, Scheduled, Manual)
- [x] Enable Push to Channel for archive summaries
- [x] Enable View Generation Details for archive summaries
- [ ] Remove separate Archive tab from Summaries page (optional - kept for backwards compatibility)

### Phase 5: Migration (Pending)
- [ ] Write migration script for existing archive files
- [ ] Test migration on staging
- [ ] Deploy migration
- [ ] Deploy migration

---

## 7. File Changes

| File | Action | Description |
|------|--------|-------------|
| `src/models/summary.py` | **M** | Add source, archive_period, generation metadata fields |
| `src/database/repositories/summary.py` | **M** | Add source filtering, archive queries |
| `src/archive/generator.py` | **M** | Save to database + Markdown file, thread PositionIndex |
| `src/archive/writer.py` | **M** | Add citations to Markdown output, include Sources table |
| `src/dashboard/routes/archive.py` | **M** | Add model selection, remove duplicate endpoints |
| `src/dashboard/routes/summaries.py` | **M** | Add source filter parameter |
| `src/frontend/src/pages/Summaries.tsx` | **M** | Unify archive display, add badges |
| `src/frontend/src/hooks/useSummaries.ts` | **M** | Add source filter parameter |
| `alembic/versions/xxx_add_summary_source.py` | **N** | Database migration |

---

## 8. Consequences

### Positive
- **Unified Experience** â€” Users see all summaries in one place with consistent features
- **Full Transparency** â€” Generation details available for all summaries
- **Shareable Archives** â€” Push retrospective summaries to Discord
- **Cost Optimization** â€” Brief summaries use cheaper models automatically
- **Simpler Mental Model** â€” Summaries are summaries, regardless of origin

### Negative
- **Migration Required** â€” Existing archive files need database migration
- **Dual Storage** â€” Summaries stored in both database and Markdown (for portability)
- **Increased Complexity** â€” Repository needs source-aware queries

### Trade-offs
- **Database vs Files**: We keep both â€” database for features, files for portability/sync
- **Model Selection**: Auto-selection is opinionated but can be overridden

---

## 9. References

- [ADR-004: Grounded Summary References](./004-grounded-summary-references.md) â€” Message-level citations for verifiable summaries
- [ADR-005: Summary Delivery Destinations](./005-summary-delivery-destinations.md) â€” Push to channel mechanism
- [ADR-006: Retrospective Summary Archive](./006-retrospective-summary-archive.md) â€” Archive system
- [OpenRouter Models](https://openrouter.ai/docs/models) â€” Model pricing reference
